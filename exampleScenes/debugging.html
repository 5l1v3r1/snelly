
<body onload="onLoad();">

<script type="text/javascript" src="../js/thirdparty/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../js/thirdparty/three/three.min.js"></script>
<script type="text/javascript" src="../js/thirdparty/three/libs/stats.min.js"></script>
<script type="text/javascript" src="../js/thirdparty/three/libs/dat.gui.min.js"></script>
<script type="text/javascript" src="../js/thirdparty/three/controls/OrbitControls.js"></script>

<script type="text/javascript" src="../js/gl.js"></script>
<script type="text/javascript" src="../js/gui.js"></script>
<script type="text/javascript" src="../js/shaders.js"></script>
<script type="text/javascript" src="../js/color.js"></script>
<script type="text/javascript" src="../js/materials.js"></script>
<script type="text/javascript" src="../js/spectra.js"></script>
<script type="text/javascript" src="../js/renderer.js"></script>
<script type="text/javascript" src="../js/snelly.js"></script>

<?/* ------------------------------------------------------------------*/?>
<?/*                         scene definition                          */?>
<?/* ------------------------------------------------------------------*/?>

<script type="text/javascript">

function Scene() {}

Scene.prototype.init = function(snelly)
{
	this.parameters = {};
	this.parameters.radius = 0.28;
	this.parameters.size = 0.22;

	let camera    = snelly.getCamera();
	let controls  = snelly.getControls();
	camera.up.set(0, 1, 0);
	camera.position.set(6.0, 3.0, -6.0);
	controls.target.set(0.0, 0.0, 0.0);

	let materials = snelly.getMaterials();
	materials.loadMetal('Copper');
	materials.loadDielectric('Diamond');

	let renderer = snelly.getRenderer();
	renderer.maxBounces = 5;

	this.FPS = 24.0;
	this.period = 30.0;
	this.animFrame = 0;
	this.advanceFrame = false;
}

Scene.prototype.shader = function()
{
	return `
		uniform float radius;
		uniform float size;
		uniform mat4 transform;
		
		float sdSphere(vec3 X, float r) { return length(X) - r; }   
		float sdBox(vec3 X, vec3 b) { vec3 d = abs(X)-b; return min(max(d.x,max(d.y,d.z)),0.0) + length(max(d,0.0)); } 
		float sdTorus( vec3 X, vec2 t ) { vec2 q = vec2(length(X.xz)-t.x, X.y); return length(q)-t.y; }

		float opIntersect(float A, float B) { return max(A, B); }

		float SDF_METAL(in vec3 X)                     
		{	
			float box    = sdBox(X, vec3(3.0*size, size, size));
			float sphere = sdSphere(X, 3.0*size);
			return opIntersect(box, sphere);
		} 

		float SDF_DIELECTRIC(in vec3 X)                     
		{	
			vec4 p = vec4(X.x, X.y, X.z, 1.0);
			vec4 q = transform*p;
			return sdTorus(q.xyz, vec2(radius, 0.333*radius));
		} 
	`;
}

Scene.prototype.initGui = function(gui)            
{
  	gui.addSlider(this.parameters, {name: 'radius', min: 0.0, max: 1.0});
  	gui.addSlider(this.parameters, {name: 'size', min: 0.0, max: 1.0});
}

Scene.prototype.syncShader = function(shader)
{
	shader.uniformF("radius", this.parameters.radius);
	shader.uniformF("size", this.parameters.size);

	let time = this.animFrame/this.FPS;
	let phase = 2.0*Math.PI*time/this.period;

	let c = Math.cos(phase);
	let s = Math.sin(phase);
 	let tx = [
       c, s, 0, 0,
      -s, c, 0, 0,
       0, 0, 1, 0,
       0, 0, 0, 1,
    ];
	shader.uniformMatrix4fv("transform", tx);
}

Scene.prototype.getScale = function()
{
	return 1.0;
}

Scene.prototype.envMap = function() { return 'https://cdn.rawgit.com/portsmouth/envmaps/74e9d389/HDR_112_River_Road_2_Bg.jpg'; }

Scene.prototype.preframeCallback = function(snelly, gl)
{
	let renderer  = snelly.getRenderer();
	let camera    = snelly.getCamera();
	let controls  = snelly.getControls();
	let materials = snelly.getMaterials();
	let gui       = snelly.getGUI();

	let time = this.animFrame/this.FPS;
	let phase = 2.0*Math.PI*time/this.period;
	this.endFrame = this.period * this.FPS;
	if (this.animFrame > this.endFrame) this.animFrame = 0;

	// Advance scene state to next anim frame, if we have reached the spp count for the previous frame
	if (this.advanceFrame || this.animFrame == 0)
	{
		// animate scene
		this.parameters.radius = 1.5 + 1.0*Math.abs(Math.cos(5.0*phase));
		this.parameters.size   = 0.5 + 0.25*Math.abs(Math.sin(3.0*phase));

		// simplistic material animation
		let metal = materials.getLoadedMetal();
		metal.roughness = Math.abs(0.01*Math.sin(6.0*phase));

		let dielectric = materials.getLoadedDielectric();
		dielectric.roughness = Math.abs(0.01*Math.cos(6.0*phase));
	}

	if (this.advanceFrame)
	{
		// Tell renderer to restart sampling
		let no_recompile = true;
		renderer.reset(no_recompile);

		this.advanceFrame = false;
	}
}

Scene.prototype.postframeCallback = function(snelly, gl)
{
	let renderer = snelly.getRenderer();
	let targetSPP = 3.0;
	if (this.animFrame>=0 && renderer.getSPP()>=targetSPP && this.animFrame<=this.endFrame)
	{
		this.advanceFrame = true;
		this.animFrame++;
	}
}

</script>

<?/* ------------------------------------------------------------------*/?>
<?/*                            main loop                              */?>
<?/* ------------------------------------------------------------------*/?>

<script type="text/javascript">

window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000/60);
          };
})();

var snelly;
function onLoad()
{
	snelly = new Snelly(new Scene());
	animateLoop();
}
function animateLoop() 
{
	snelly.render();
	window.requestAnimFrame(animateLoop);
}

</script>

</body>


