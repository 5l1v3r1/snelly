

<body onload="onLoad();">

<?/* ----------- @todo: embed CSS here, no external file ------------*/?>
 <head>
<link rel="stylesheet" type="text/css" href="snelly.css">
</head>

<div id="container">
    <div id="webglContainer"></div> <canvas id="render-canvas"></canvas>
    <div id="textContainer"><canvas id="text-canvas"></canvas></div>  
</div>


<script type="text/javascript" src="js/thirdparty/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/thirdparty/three/three.min.js"></script>
<script type="text/javascript" src="js/thirdparty/three/libs/stats.min.js"></script>
<script type="text/javascript" src="js/thirdparty/three/libs/dat.gui.min.js"></script>
<script type="text/javascript" src="js/thirdparty/three/controls/OrbitControls.js"></script>

<script type="text/javascript" src="js/gl.js"></script>
<script type="text/javascript" src="js/gui.js"></script>
<script type="text/javascript" src="js/shaders.js"></script>
<script type="text/javascript" src="js/color.js"></script>
<script type="text/javascript" src="js/materials.js"></script>
<script type="text/javascript" src="js/spectra.js"></script>
<script type="text/javascript" src="js/pathtracer.js"></script>
<script type="text/javascript" src="js/snelly.js"></script>


<?/* ------------------------------------------------------------------*/?>
<?/*                         scene definition                          */?>
<?/* ------------------------------------------------------------------*/?>

<script type="text/javascript">

function Scene() 
{
	// initial UI scene parameters
	this.parameters = {};

	// scene settings:
	this.parameters.foo = 2.0;
	this.parameters.bar = 2.0;
}

// Optional name and description 
Scene.prototype.getName = function() { return "Hello world"; }
Scene.prototype.getDesc = function() { return "A simple example"; }


/////////////////////////////////////////////////////////////////////////////////////
// Shader code
/////////////////////////////////////////////////////////////////////////////////////

Scene.prototype.shader = function()
{
	return `
		uniform float _foo;
		uniform float _bar;

		float sdSphere(vec3 X, float r)                  
		{                                     
			return length(X) - r;       
		}   

		float sdBox(vec3 X, vec3 bmin, vec3 bmax)                     
		{                            
			vec3 center = 0.5*(bmin + bmax);
			vec3 halfExtents = 0.5*(bmax - bmin);         
			vec3 d = abs(X-center) - halfExtents;
			return min(max(d.x,max(d.y,d.z)),0.0) + length(max(d,0.0));     
		} 

		// Any of the user-defined functions below can be omitted, in which case it will be
		// replaced with the default indicated.
		// Note that the reflectances can be treated as [0,1] RGB values in sRGB color space.


		//////////////////////////////////////////////////////
		// Surface
		//////////////////////////////////////////////////////

		float SDF_SURFACE(in vec3 X)                     
		{
			vec3 bmin = vec3(-100.0, -1.0, -100.0);
			vec3 bmax = vec3( 100.0,  0.0,  100.0);
			float floor = sdBox(X, bmin, bmax);
			return floor;    
		}  

		// space-varying multiplier to the UI-exposed color (defaults to vec3(1.0))
		vec3 SURFACE_DIFFUSE_REFLECTANCE(in vec3 X)
		{
			float ax = 1.0 - pow(0.5*(1.0 + cos(50.0*X.x)), 100.0);
			float ay = 1.0 - pow(0.5*(1.0 + cos(50.0*X.z)), 100.0);
			float albedo = ax*ay;
		    return vec3(albedo);
		}

		// space-varying multiplier to the UI-exposed color (defaults to vec3(1.0))
		vec3 SURFACE_SPECULAR_REFLECTANCE(in vec3 X)
		{
		    return vec3(1.0);
		}

		// space-varying multiplier to the UI-exposed constant (defaults to 1.0)
		float SURFACE_IOR(in vec3 X)
		{
		    return 1.0;
		}

		// space-varying multiplier to the UI-exposed constant (defaults to 1.0)
		float SURFACE_ROUGHNESS(in vec3 X)
		{
		    return 1.0;
		}


		//////////////////////////////////////////////////////
		// Metal
		//////////////////////////////////////////////////////   
		
		float SDF_METAL(in vec3 X)                     
		{	
			 return sdSphere(X - vec3(5.0, 0.0, 0.0), _foo);
		}  

		// space-varying multiplier to the UI-exposed color (defaults to vec3(1.0))
		vec3 METAL_SPECULAR_REFLECTANCE(in vec3 X)
		{
		    return vec3(1.0, 1.0, 1.0);
		}

		// space-varying multiplier to the UI-exposed constant (defaults to 1.0)
		float METAL_ROUGHNESS(in vec3 X)
		{
		    return 1.0;
		}


		//////////////////////////////////////////////////////
		// Dielectric
		//////////////////////////////////////////////////////   
		
		float SDF_DIELECTRIC(vec3 X)                     
		{
		    return sdSphere(X, _bar);
		}  

		// space-varying multiplier to the UI-exposed color (defaults to vec3(1.0))
		vec3 DIELECTRIC_SPECULAR_REFLECTANCE(in vec3 X)
		{
		    return vec3(1.0, 1.0, 1.0);
		}

		// space-varying multiplier to the UI-exposed constant (defaults to 1.0)
		float DIELECTRIC_ROUGHNESS(in vec3 X)
		{
		    return 1.0;
		}


		////////////////////////////////////////////////////////////////////// end of shader code
	`;
}


// set up gui and callbacks for this scene
Scene.prototype.initGui = function(gui)            
{
  	gui.addParameter(this.parameters, {name: 'foo', min: 0.0, max: 10.0});
  	gui.addParameter(this.parameters, {name: 'bar', min: 0.0, max: 10.0});
}

// Called whenever the UI is changed,
// and must sync the params of the shader with the current UI settings
Scene.prototype.syncShader = function(shader)
{
	shader.uniformF("_foo", this.parameters.foo);
	shader.uniformF("_bar", this.parameters.bar);
}

// Gives the raytracer some indication of the (rough) scene length scale, so it can set 
// tolerances appropriately. Note, the raymarcher will march no further from the camera 
// than 100 times this scale, and the smallest resolvable structure is about 1.0e-5 this scale.
Scene.prototype.getScale = function()
{
	return 1.0;
}

// Initial settings for this scene
Scene.prototype.initCamera = function(camera, controls)
{
	// camera:
	// camera is a THREE.PerspectiveCamera object
	// controls is a THREE.OrbitControls object
	camera.fov = 60.0;
	camera.up.set(0.0, 1.0, 0.0);
	camera.lookAt(new THREE.Vector3(2.01584, -0.603169, -0.808580));
	camera.position.set(-4.81888, 2.39746, 3.47067);

	controls.zoomSpeed = 1.0;
	controls.keyPanSpeed = 10.0 * this.getScale();
}

Scene.prototype.initRenderer = function(renderer)
{
	renderer.mode = 'pt';  // The other modes are: 'ao', 'normals'
	renderer.maxBounces = 3;
	renderer.maxMarchSteps = 256;
	renderer.radianceClamp = 3.0; // (log scale)
	renderer.skyPower = 5.0;
	renderer.skyTemperature = 6000.0;
	renderer.exposure = 1.0;
	renderer.gamma = 2.2;
	renderer.whitepoint = 2.0;
}

Scene.prototype.initMaterials = function(materials)
{
	var surface = materials.loadSurface();
	surface.roughness = 0.1;
	surface.ior = 1.5;
	surface.diffuseAlbedo = [0.3, 1.0, 0.0];
	surface.specAlbedo = [0.1, 0.1, 0.1];

	var dielectric = materials.loadDielectric("Diamond");
	dielectric.absorptionColor = [1.0, 0.2, 0.1];
	dielectric.absorptionScale = 3.0; // mfp in multiples of scene scale
	dielectric.roughness = 0.01;

	var metal = materials.loadMetal("Gold");
	metal.roughness = 0.05;
}


// optionally supply an env-map texture URL (should be lat-long)
Scene.prototype.envMap = function()
{
		//return '';
  	return 'https://cdn.rawgit.com/portsmouth/envmaps/74e9d389/HDR_040_Field_Bg.jpg';
  	//return 'https://cdn.rawgit.com/portsmouth/envmaps/7405220b/HDR_041_Path_Bg.jpg';
  	//return 'https://cdn.rawgit.com/portsmouth/envmaps/74e9d389/HDR_112_River_Road_2_Bg.jpg';
  	//return 'https://cdn.rawgit.com/portsmouth/envmaps/7405220b/HDR_110_Tunnel_Bg.jpg';
  	//return 'https://cdn.rawgit.com/portsmouth/envmaps/7405220b/HDR_Free_City_Night_Lights_Bg.jpg';
}

</script>



<?/* -----------------------------------------------------------------*/?>

<script type="text/javascript">

// Snelly object
var snelly;

// shim layer with setTimeout fallback
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000/60);
          };
})();

function onLoad()
{
	snelly = new Snelly(new Scene());
	animateLoop();
}

function animateLoop() 
{
	snelly.render();
	window.requestAnimFrame(animateLoop);
}

</script>
</body>


